/*--------------------------------*- C++ -*----------------------------------*\
| =========                 |                                                 |
| \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox           |
|  \\    /   O peration     | Version:  v2312                                 |
|   \\  /    A nd           | Website:  www.openfoam.com                      |
|    \\/     M anipulation  |                                                 |
\*---------------------------------------------------------------------------*/
FoamFile
{
    version     2.0;
    format      ascii;
    class       dictionary;
    location    "system";
    object      fvOptions;
}
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //

BoussinesqSource
{
    type            vectorCodedSource;
    selectionMode   all;
    fields          ( U );
    name            BoussinesqSource;

    codeInclude
    #{
    #};

    codeCorrect
    #{
        Info<< "CodeCorrect" << endl << "\n";
    #};

    codeConstrain
    #{
        Info<< "CodeConstrain" << endl << "\n";
    #};

    codeAddSup
    #{
        Info << "Adding Boussinesq buoyancy source term" << endl;

        const dimensionedScalar T_ref
        (
            "T_ref",
            dimensionSet(0, 0, 0, 1, 0, 0, 0),
            mesh().time().controlDict().lookup("T_ref")[0].number()
        );

        const dimensionedScalar beta
        (
            "beta",
            dimensionSet(0, 0, 0, -1, 0, 0, 0),
            mesh().time().controlDict().lookup("beta")[0].number()
        );

        const dimensionedVector g
        (
            "g",
            dimensionSet(0, 1, -2, 0, 0, 0, 0),
            vector(0, mesh().time().controlDict().lookup("g")[0].number(), 0) 
        );

        const scalarField& V = mesh_.V();

        const volScalarField& Temp = mesh_.lookupObject<volScalarField>("T");
        const label wallsID = mesh_.boundaryMesh().findPatchID("walls");
        const scalarField& T_w = Temp.boundaryField()[wallsID];

        const scalar Tb = gSum(Temp*V)/gSum(V);

        forAll(V, i)
        {
            eqn.source()[i] += g.value()*beta.value()*(average(T_w) - T_ref.value())*V[i];
        }
        
    #};
}

// ************************************************************************* //
